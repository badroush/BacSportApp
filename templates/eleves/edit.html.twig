{% extends 'base.html.twig' %}

{% block title %} ØªØ¹Ø¯ÙŠÙ„ ØªÙ„Ù…ÙŠØ° {% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ø·ÙŠØ§Øª Ø§Ù„ØªÙ„Ù…ÙŠØ°  âœï¸ </h3>
            <a href="{{ path('app_eleves') }}" class="btn btn-secondary">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</a>
        </div>
    </div>


    {{ form_start(form) }}
    <div class="mb-3">
        {{ form_widget(form.matricule, {'attr': {'class': 'form-control', 'readonly': 'readonly'}}) }}
    </div>  
    <div class="mb-3">
        {{ form_widget(form.cin, {'attr': {'class': 'form-control', 'placeholder': 'Ø±Ù‚Ù… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ·Ù†ÙŠØ©', 'dir': 'rtl','readonly': 'readonly'}}) }}
    </div>  
    <div class="mb-3">
        {{ form_widget(form.nomPrenom, {'attr': {'class': 'form-control', 'placeholder': 'Ø§Ù„Ø§Ø³Ù… Ùˆ Ø§Ù„Ù„Ù‚Ø¨', 'dir': 'rtl'}}) }}
    </div>
    <div class="mb-3">
        {{ form_widget(form.sexe, {'attr': {'class': 'form-select', 'placeholder': 'Ø§Ù„Ø¬Ù†Ø³', 'dir': 'rtl'}}) }}
    </div>
    <div class="mb-3">
        {{ form_widget(form.lycee, {'attr': {'class': 'form-select', 'id': 'eleve_type_form_lycee','dir': 'rtl', 'placeholder': 'Ø§Ù„Ù…Ø¹Ù‡Ø¯'}}) }}
    </div>
    <div class="mb-3">
        {{ form_widget(form.classe, {'attr': {'class': 'form-select', 'id': 'eleve_type_form_classe', 'data-selected': selectedClasseId|default(''), 'dir': 'rtl'}}) }}
    </div>
    <button type="submit" class="btn btn-success w-100">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø·ÙŠØ§Øª  ğŸ’¾</button>
    {{ form_end(form) }}

    <!-- Preloader (ex : un spinner Bootstrap) -->
		<div id="preloader" style="
															position: fixed;
															top: 0;
															left: 0;
															width: 100vw;
															height: 100vh;
															background: rgba(255, 255, 255, 0.85);
															z-index: 9999;
															display: none;
															align-items: center;
															justify-content: center;
															flex-direction: column;
																">
			<img src="{{ asset('build/img/loader.gif') }}" style="width: 60px;">
			<p class="mt-3 text-primary">ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø·ÙŠØ§Øª Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p>
		</div>
</div>

{% endblock %}

{% block javascripts %}
<script>
window.attachLyceeClasseListener = function(container = document) {
    const lyceeSelect = container.querySelector('#eleve_type_form_lycee');
    const classeSelect = container.querySelector('#eleve_type_form_classe');
    if (!lyceeSelect || !classeSelect) return;

    function loadClasses(lyceeId, selectedClasseId = '') {
        if (!lyceeId) {
            classeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
            classeSelect.disabled = true;
            return;
        }
        classeSelect.innerHTML = '<option>Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';
        classeSelect.disabled = true;

        fetch(`/api/classes/${lyceeId}`)
            .then(response => response.json())
            .then(data => {
                classeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
                data.forEach(classe => {
                    const option = document.createElement('option');
                    option.value = classe.id;
                    option.text = classe.nom;
                    if (classe.id == selectedClasseId) option.selected = true;
                    classeSelect.appendChild(option);
                });
                classeSelect.disabled = false;
            })
            .catch(() => {
                classeSelect.innerHTML = '<option>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
            });
    }

    lyceeSelect.addEventListener('change', () => {
        loadClasses(lyceeSelect.value);
    });

    const selectedClasseId = classeSelect.getAttribute('data-selected') || '';
    if (lyceeSelect.value) {
        loadClasses(lyceeSelect.value, selectedClasseId);
    }
};

document.addEventListener('DOMContentLoaded', () => {
    window.attachLyceeClasseListener(document);
});
</script>

<script>
function updateClasseOptions(lyceeId, selectedClasseId = null) {
    const classeSelect = document.getElementById('eleve_type_form_classe');
    if (!classeSelect) return;

    if (!lyceeId ) {
        classeSelect.innerHTML = '<option>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
        classeSelect.disabled = false;
        return;
    }

    classeSelect.innerHTML = '<option>Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';
    classeSelect.disabled = false;

    fetch(`/api/classe/${lyceeId}`)
        .then(response => response.json())
        .then(data => {
            classeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
            data.forEach(classe => {
                const option = document.createElement('option');
                option.value = classe.id;
                option.textContent = classe.nom+' '+classe.num;
                if (selectedClasseId && classe.id == selectedClasseId) {
                    option.selected = true;
                }
                classeSelect.appendChild(option);
            });
            classeSelect.disabled = false;
        })
        .catch(() => {
            classeSelect.innerHTML = '<option>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
        });
}

document.addEventListener('DOMContentLoaded', function () {
    const lyceeSelect = document.getElementById('eleve_type_form_lycee');
    const selectedClasseId = document.getElementById('eleve_type_form_classe')?.dataset?.selected;

    if (lyceeSelect) {
        // Initialisation : charger les classes si lycÃ©e prÃ©-sÃ©lectionnÃ©
        if (lyceeSelect.value) {
            
            updateClasseOptions(lyceeSelect.value, selectedClasseId);
        } else {
            document.getElementById('eleve_type_form_classe').disabled = false;
        }

        lyceeSelect.addEventListener('change', function () {
            updateClasseOptions(this.value);
        });
    }
});

function showFlash(type, message) {
    Swal.fire({
        icon: type === 'success' ? 'success' : type === 'error' ? 'error' : 'info',
        title: type.charAt(0).toUpperCase() + type.slice(1),
        text: message,
        confirmButtonText: 'OK'
    });
}
</script>

<script>
		document.addEventListener("DOMContentLoaded", function () {
const form = document.querySelector('form[name="{{ form.vars.name }}"]');
const preloader = document.getElementById('preloader');
console.log(form,preloader);
if (form && preloader) {
form.addEventListener('submit', function () {
preloader.style.display = 'flex';
document.body.style.overflow = 'hidden';
});
}
});
	</script>

{% endblock %}
